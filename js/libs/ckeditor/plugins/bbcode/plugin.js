!function(){function i(a){var b="";for(var c in a){var d=a[c],e=(c+":"+d).replace(h,";");b+=e}return b}CKEDITOR.on("dialogDefinition",function(a){var b,c=a.data.name,d=a.data.definition;"link"==c?(d.removeContents("target"),d.removeContents("upload"),d.removeContents("advanced"),b=d.getContents("info"),b.remove("emailSubject"),b.remove("emailBody")):"image"==c&&(d.removeContents("advanced"),b=d.getContents("Link"),b.remove("cmbTarget"),b=d.getContents("info"),b.remove("txtAlt"),b.remove("basic"))});var a={b:"strong",u:"u",i:"em",color:"span",size:"span",quote:"blockquote",code:"code",url:"a",email:"span",img:"span","*":"li",list:"ol"},b={strong:"b",b:"b",u:"u",em:"i",i:"i",code:"code",li:"*"},c={strong:"b",em:"i",u:"u",li:"*",ul:"list",ol:"list",code:"code",a:"link",img:"img",blockquote:"quote"},d={color:"color",size:"font-size"},e={url:"href",email:"mailhref",quote:"cite",list:"listType"},f=CKEDITOR.dtd,g=CKEDITOR.tools.extend({table:1},f.$block,f.$listItem,f.$tableContent,f.$list),h=/\s*(?:;\s*|$)/,j={smiley:":)",sad:":(",wink:";)",laugh:":D",cheeky:":P",blush:":*)",surprise:":-o",indecision:":|",angry:">:(",angel:"o:)",cool:"8-)",devil:">:-)",crying:";(",kiss:":-*"},k={},l=[];for(var m in j)k[j[m]]=m,l.push(j[m].replace(/\(|\)|\:|\/|\*|\-|\|/g,function(a){return"\\"+a}));l=new RegExp(l.join("|"),"g");var n=function(){var a=[],b={nbsp:" ",shy:"­"};for(var c in b)a.push(c);return a=new RegExp("&("+a.join("|")+");","g"),function(c){return c.replace(a,function(a,c){return b[c]})}}();CKEDITOR.BBCodeParser=function(){this._={bbcPartsRegex:/(?:\[([^\/\]=]*?)(?:=([^\]]*?))?\])|(?:\[\/([a-z]{1,16})\])/gi}},CKEDITOR.BBCodeParser.prototype={parse:function(b){for(var c,f,g=0;c=this._.bbcPartsRegex.exec(b);){var h=c.index;if(h>g){var j=b.substring(g,h);this.onText(j,1)}if(g=this._.bbcPartsRegex.lastIndex,f=(c[1]||c[3]||"").toLowerCase(),!f||a[f])if(c[1]){var k=a[f],l={},m={},n=c[2];n&&("list"==f&&(isNaN(n)?/^[a-z]+$/.test(n)?n="lower-alpha":/^[A-Z]+$/.test(n)&&(n="upper-alpha"):n="decimal"),d[f]?("size"==f&&(n+="%"),m[d[f]]=n,l.style=i(m)):e[f]&&(l[e[f]]=CKEDITOR.tools.htmlDecode(n))),"email"!=f&&"img"!=f||(l.bbcode=f),this.onTagOpen(k,l,CKEDITOR.dtd.$empty[k])}else c[3]&&this.onTagClose(a[f]);else this.onText(c[0])}b.length>g&&this.onText(b.substring(g,b.length),1)}},CKEDITOR.htmlParser.fragment.fromBBCode=function(a){function j(a){if(e.length>0)for(var b=0;b<e.length;b++){var c=e[b],d=c.name,f=CKEDITOR.dtd[d],g=h.name&&CKEDITOR.dtd[h.name];g&&!g[d]||a&&f&&!f[a]&&CKEDITOR.dtd[a]||(c=c.clone(),c.parent=h,h=c,e.splice(b,1),b--)}}function m(a,b){var d=h.children.length,e=d>0&&h.children[d-1],i=!e&&p.getRule(c[h.name],"breakAfterOpen"),j=e&&e.type==CKEDITOR.NODE_ELEMENT&&p.getRule(c[e.name],"breakAfterClose"),k=a&&p.getRule(c[a],b?"breakBeforeClose":"breakBeforeOpen");f&&(i||j||k)&&f--,f&&a in g&&f++;for(;f&&f--;)h.children.push(e=new CKEDITOR.htmlParser.element("br"))}function n(a,b){m(a.name,1),b=b||h||d;var c=b.children.length,e=c>0&&b.children[c-1]||null;a.previous=e,a.parent=b,b.children.push(a),a.returnPoint&&(h=a.returnPoint,delete a.returnPoint)}var i,b=new CKEDITOR.BBCodeParser,d=new CKEDITOR.htmlParser.fragment,e=[],f=0,h=d;b.onTagOpen=function(a,c){var d=new CKEDITOR.htmlParser.element(a,c);if(CKEDITOR.dtd.$removeEmpty[a])return void e.push(d);var f=h.name,g=f&&(CKEDITOR.dtd[f]||(h._.isBlockLike?CKEDITOR.dtd.div:CKEDITOR.dtd.span));if(g&&!g[a]){var l,k=!1;if(a==f?n(h,h.parent):a in CKEDITOR.dtd.$listItem?(b.onTagOpen("ul",{}),l=h,k=!0):(n(h,h.parent),e.unshift(h),k=!0),h=l?l:h.returnPoint||h.parent,k)return void b.onTagOpen.apply(this,arguments)}j(a),m(a),d.parent=h,d.returnPoint=i,i=0,d.isEmpty?n(d):h=d},b.onTagClose=function(a){for(var b=e.length-1;b>=0;b--)if(a==e[b].name)return void e.splice(b,1);for(var c=[],d=[],f=h;f.type&&f.name!=a;)f._.isBlockLike||d.unshift(f),c.push(f),f=f.parent;if(f.type){for(b=0;b<c.length;b++){var g=c[b];n(g,g.parent)}h=f,n(f,f.parent),f==h&&(h=h.parent),e=e.concat(d)}},b.onText=function(a){var b=CKEDITOR.dtd[h.name];b&&!b["#"]||(m(),j(),a.replace(/(\r\n|[\r\n])|[^\r\n]*/g,function(a,b){if(void 0!==b&&b.length)f++;else if(a.length){var c=0;a.replace(l,function(b,d){n(new CKEDITOR.htmlParser.text(a.substring(c,d)),h),n(new CKEDITOR.htmlParser.element("smiley",{desc:k[b]}),h),c=d+b.length}),c!=a.length&&n(new CKEDITOR.htmlParser.text(a.substring(c,a.length)),h)}}))},b.parse(CKEDITOR.tools.htmlEncode(a));for(;h.type!=CKEDITOR.NODE_DOCUMENT_FRAGMENT;){var o=h.parent,q=h;n(q,o),h=o}return d};var o=CKEDITOR.tools.createClass({$:function(){this._={output:[],rules:[]},this.setRules("list",{breakBeforeOpen:1,breakAfterOpen:1,breakBeforeClose:1,breakAfterClose:1}),this.setRules("*",{breakBeforeOpen:1,breakAfterOpen:0,breakBeforeClose:1,breakAfterClose:0}),this.setRules("quote",{breakBeforeOpen:1,breakAfterOpen:0,breakBeforeClose:0,breakAfterClose:1})},proto:{setRules:function(a,b){var c=this._.rules[a];c?CKEDITOR.tools.extend(c,b,!0):this._.rules[a]=b},getRule:function(a,b){return this._.rules[a]&&this._.rules[a][b]},openTag:function(b){b in a&&(this.getRule(b,"breakBeforeOpen")&&this.lineBreak(1),this.write("[",b))},openTagClose:function(b){"br"==b?this._.output.push("\n"):b in a&&(this.write("]"),this.getRule(b,"breakAfterOpen")&&this.lineBreak(1))},attribute:function(a,b){"option"==a&&this.write("=",b)},closeTag:function(b){b in a&&(this.getRule(b,"breakBeforeClose")&&this.lineBreak(1),"*"!=b&&this.write("[/",b,"]"),this.getRule(b,"breakAfterClose")&&this.lineBreak(1))},text:function(a){this.write(a)},comment:function(){},lineBreak:function(){!this._.hasLineBreak&&this._.output.length&&(this.write("\n"),this._.hasLineBreak=1)},write:function(){this._.hasLineBreak=0;var a=Array.prototype.join.call(arguments,"");this._.output.push(a)},reset:function(){this._.output=[],this._.hasLineBreak=0},getHtml:function(a){var b=this._.output.join("");return a&&this.reset(),n(b)}}}),p=new o;CKEDITOR.plugins.add("bbcode",{requires:"entities",beforeInit:function(a){var b=a.config;CKEDITOR.tools.extend(b,{enterMode:CKEDITOR.ENTER_BR,basicEntities:!1,entities:!1,fillEmptyBlocks:!1},!0),a.filter.disable(),a.activeEnterMode=a.enterMode=CKEDITOR.ENTER_BR},init:function(a){function d(a){var b=CKEDITOR.htmlParser.fragment.fromBBCode(a),c=new CKEDITOR.htmlParser.basicWriter;return b.writeHtml(c,e),c.getHtml(!0)}function f(a){var b=a.data.dataValue;a.data.dataValue=d(b)}var c=a.config,e=new CKEDITOR.htmlParser.filter;e.addRules({elements:{blockquote:function(a){var b=new CKEDITOR.htmlParser.element("div");b.children=a.children,a.children=[b];var c=a.attributes.cite;if(c){var d=new CKEDITOR.htmlParser.element("cite");d.add(new CKEDITOR.htmlParser.text(c.replace(/^"|"$/g,""))),delete a.attributes.cite,a.children.unshift(d)}},span:function(a){var b;(b=a.attributes.bbcode)&&("img"==b?(a.name="img",a.attributes.src=a.children[0].value,a.children=[]):"email"==b&&(a.name="a",a.attributes.href="mailto:"+a.children[0].value),delete a.attributes.bbcode)},ol:function(a){a.attributes.listType?"decimal"!=a.attributes.listType&&(a.attributes.style="list-style-type:"+a.attributes.listType):a.name="ul",delete a.attributes.listType},a:function(a){a.attributes.href||(a.attributes.href=a.children[0].value)},smiley:function(a){a.name="img";var b=a.attributes.desc,d=c.smiley_images[CKEDITOR.tools.indexOf(c.smiley_descriptions,b)],e=CKEDITOR.tools.htmlEncode(c.smiley_path+d);a.attributes={src:e,"data-cke-saved-src":e,title:b,alt:b}}}}),a.dataProcessor.htmlFilter.addRules({elements:{$:function(c){var f,d=c.attributes,e=CKEDITOR.tools.parseCssText(d.style,1),g=c.name;if(g in b)g=b[g];else if("span"==g){if(f=e.color)g="color",f=CKEDITOR.tools.convertRgbToHex(f);else if(f=e["font-size"]){var h=f.match(/(\d+)%$/);h&&(f=h[1],g="size")}}else if("ol"==g||"ul"==g){if(f=e["list-style-type"])switch(f){case"lower-alpha":f="a";break;case"upper-alpha":f="A"}else"ol"==g&&(f=1);g="list"}else if("blockquote"==g){try{var i=c.children[0],k=c.children[1],l="cite"==i.name&&i.children[0].value;l&&(f='"'+l+'"',c.children=k.children)}catch(a){}g="quote"}else if("a"==g){if(f=d.href)if(f.indexOf("mailto:")!==-1)g="email",c.children=[new CKEDITOR.htmlParser.text(f.replace("mailto:",""))],f="";else{var m=1==c.children.length&&c.children[0];m&&m.type==CKEDITOR.NODE_TEXT&&m.value==f&&(f=""),g="url"}}else if("img"==g){c.isEmpty=0;var n=d["data-cke-saved-src"]||d.src,o=d.alt;if(n&&n.indexOf(a.config.smiley_path)!=-1&&o)return new CKEDITOR.htmlParser.text(j[o]);c.children=[new CKEDITOR.htmlParser.text(n)]}return c.name=g,f&&(c.attributes.option=f),null},br:function(a){var b=a.next;if(b&&b.name in g)return!1}}},1),a.dataProcessor.writer=p,a.elementMode==CKEDITOR.ELEMENT_MODE_INLINE?a.once("contentDom",function(){a.on("setData",f)}):a.on("setData",f)},afterInit:function(a){var b;a._.elementsPath&&(b=a._.elementsPath.filters)&&b.push(function(b){var d=b.getName(),e=c[d]||!1;if("link"==e&&0===b.getAttribute("href").indexOf("mailto:"))e="email";else if("span"==d)b.getStyle("font-size")?e="size":b.getStyle("color")&&(e="color");else if("img"==e){var f=b.data("cke-saved-src")||b.getAttribute("src");f&&0===f.indexOf(a.config.smiley_path)&&(e="smiley")}return e})}})}();